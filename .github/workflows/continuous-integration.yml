name: Continuous Integration

# The Nyx CI pipeline running on GitHub Actions
#
# The pipeline uses Gradle tasks for each job and in order to make it incremental the cache is used to store
# the various 'build' directories between tasks (considering each job runs on a different fresh node).
#
# CACHE
# The cache is scoped to the current pipeline so every new pipeline starts with no cache, while each job
# ends by caching its cached outputs so that next jobs can start from there.
# If the cache action finds a stored cache with the given key it pulls when it's setting up but never updates
# it in the post actions.
# The problem with this approach if using the same cache key in all jobs is that only the first job updates
# the cache but next jobs always get the cache from the first job, not from next ones.
# To work around this problem each job uses a 'restore-keys' with the key generated from the previous
# job, while its own 'key' is specific (and can be used by next jobs). This prodices a chain of caches
# but it's the only way to have the cache incremented at each job.
# To make sure the cache is used take a look at the logs and see the Gradle tasks status (UP-TO-DATE).

on: [push]

jobs:
  assemble:
    runs-on: ubuntu-latest
    steps:
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    # Start with a new empty cache (no restore-keys) and save the job output cache as -assemble
    - name: Set up the pipeline cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          build/
          **/build/
        key: ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-assemble
        #restore-keys: not used here, start from scratch
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Assemble with Gradle
      run: ./gradlew assemble --stacktrace

  test:
    needs: assemble
    runs-on: ubuntu-latest
    steps:
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    # Start from the -assemble cache and save the job output cache as -test
    - name: Set up the pipeline cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          build/
          **/build/
        key: ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-test
        restore-keys: |
          ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-assemble
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Test with Gradle
      run: ./gradlew test --stacktrace
  
  check:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    # Start from the -test cache and save the job output cache as -check
    - name: Set up the pipeline cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          build/
          **/build/
        key: ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-check
        restore-keys: |
          ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-test
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Check with Gradle
      env:
          # See the top level https://github.com/mooltiverse/nyx/blob/master/CONTRIBUTING.md#contributing-code file for details about passing these values when testing locally
          ORG_GRADLE_PROJECT_gitHubTestUserToken: ${{ secrets.TEST_GITHUB_USER_TOKEN }}   # The test user token to test Nyx GitHub features
          ORG_GRADLE_PROJECT_gitLabTestUserToken: ${{ secrets.TEST_GITLAB_USER_TOKEN }}   # The test user token to test Nyx GitLab features
      run: ./gradlew check --stacktrace

  build:
    needs: [assemble,check]
    runs-on: ubuntu-latest
    steps:
    - name: Git checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    # Start from the -check cache and save the job output cache as -build
    - name: Set up the pipeline cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          build/
          **/build/
        key: ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-build
        restore-keys: |
          ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-check
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: Build with Gradle
      run: ./gradlew build --stacktrace

  publish:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      # Start from the -build cache and save the job output cache as -publish
      - name: Set up the pipeline cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            build/
            **/build/
          key: ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-publish
          restore-keys: |
            ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-build
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Publish with Gradle
        env:
          # See the top level https://github.com/mooltiverse/nyx/blob/master/CONTRIBUTING.md#contributing-code file for details about passing these values when testing locally
          ORG_GRADLE_PROJECT_gitHubUser: ${{ secrets.GITHUB_USERNAME }}
          ORG_GRADLE_PROJECT_gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          ORG_GRADLE_PROJECT_ossrhUsername: ${{ secrets.MAVEN_USER }}
          ORG_GRADLE_PROJECT_ossrhPassword: ${{ secrets.MAVEN_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKeyBase64: ${{ secrets.GPG_PRIVATE_KEY_BASE64 }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPC_PASSPHRASE }}
          ORG_GRADLE_PROJECT_gradlePublishKey: ${{ secrets.GRADLE_PLUGIN_PUBLISH_KEY }}
          ORG_GRADLE_PROJECT_gradlePublishSecret: ${{ secrets.GRADLE_PLUGIN_PUBLISH_SECRET }}
        run: ./gradlew publish --stacktrace

  release:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      # Start from the -publish cache and save the job output cache as -release
      - name: Set up the pipeline cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            build/
            **/build/
          key: ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-release
          restore-keys: |
            ${{ runner.os }}-nyx-gradle-${{ github.run_id }}-publish
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Release with Gradle
        env:
          # See the top level https://github.com/mooltiverse/nyx/blob/master/CONTRIBUTING.md#contributing-code file for details about passing these values when testing locally
          ORG_GRADLE_PROJECT_gitHubUser: ${{ secrets.GITHUB_USERNAME }}
          ORG_GRADLE_PROJECT_gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        run: ./gradlew release --debug --stacktrace
